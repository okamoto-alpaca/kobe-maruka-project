{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%E5%B2%A1%E6%9C%AC%E3%80%80%E6%99%83%E4%B8%80/projects/kobe-maruka-project/web/src/lib/firebase-admin.ts"],"sourcesContent":["import * as admin from 'firebase-admin';\r\n\r\nif (!process.env.FIRESTORE_EMULATOR_HOST) {\r\n    // In production, we would check for service account credentials here.\r\n    // For this dev environment, we enforce emulator usage or specific setup.\r\n    console.warn(\"FIRESTORE_EMULATOR_HOST is not set. Ensure you are connecting to the correct instance.\");\r\n}\r\n\r\nif (admin.apps.length === 0) {\r\n    admin.initializeApp({\r\n        projectId: 'demo-no-project',\r\n    });\r\n}\r\n\r\nexport const db = admin.firestore();\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,uBAAuB,EAAE;IACtC,sEAAsE;IACtE,yEAAyE;IACzE,QAAQ,IAAI,CAAC;AACjB;AAEA,IAAI,mIAAU,CAAC,MAAM,KAAK,GAAG;IACzB,4IAAmB,CAAC;QAChB,WAAW;IACf;AACJ;AAEO,MAAM,KAAK,wIAAe"}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%E5%B2%A1%E6%9C%AC%E3%80%80%E6%99%83%E4%B8%80/projects/kobe-maruka-project/web/src/app/api/allocate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { db } from '@/lib/firebase-admin';\r\nimport { Supply, Allocation } from '@/types/schema';\r\nimport { Timestamp } from 'firebase-admin/firestore';\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        const body = await req.json();\r\n        const { supplyId, customerName, quantity, userId, userEmail } = body;\r\n\r\n        if (!supplyId || !customerName || !quantity || !userId) {\r\n            return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 });\r\n        }\r\n\r\n        const requestQuantity = Number(quantity);\r\n        if (isNaN(requestQuantity) || requestQuantity <= 0) {\r\n            return NextResponse.json({ error: \"Invalid quantity\" }, { status: 400 });\r\n        }\r\n\r\n        const result = await db.runTransaction(async (transaction) => {\r\n            const supplyRef = db.collection('supplies').doc(supplyId);\r\n            const supplyDoc = await transaction.get(supplyRef);\r\n\r\n            if (!supplyDoc.exists) {\r\n                throw new Error(\"Supply not found\");\r\n            }\r\n\r\n            const supplyData = supplyDoc.data() as Supply;\r\n            const currentQty = supplyData.currentQuantity;\r\n\r\n            if (currentQty < requestQuantity) {\r\n                throw new Error(\"Inventory Shortage\");\r\n            }\r\n\r\n            const newQty = currentQty - requestQuantity;\r\n\r\n            // 1. Update Supply\r\n            transaction.update(supplyRef, { currentQuantity: newQty });\r\n\r\n            // 2. Create Allocation\r\n            const allocationRef = db.collection('allocations').doc();\r\n            const allocation: any = { // Use any to bypass strict type check for now or update type definition\r\n                id: allocationRef.id,\r\n                supplyId: supplyId,\r\n                customerName: customerName,\r\n                allocatedQuantity: requestQuantity,\r\n                allocatedAt: Timestamp.now(),\r\n                executedBy: {\r\n                    uid: userId,\r\n                    email: userEmail || 'unknown'\r\n                }\r\n            };\r\n            transaction.set(allocationRef, allocation);\r\n\r\n            return { newQty, allocationId: allocationRef.id };\r\n        });\r\n\r\n        return NextResponse.json({ status: \"success\", ...result });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Allocate API Error:\", error);\r\n        if (error.message === \"Inventory Shortage\") {\r\n            return NextResponse.json({ error: \"Inventory Shortage\" }, { status: 409 }); // Conflict\r\n        }\r\n        if (error.message === \"Supply not found\") {\r\n            return NextResponse.json({ error: \"Supply not found\" }, { status: 404 });\r\n        }\r\n        return NextResponse.json({ error: error.message || \"Internal Server Error\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AAEA;;;;;;;;AAEO,eAAe,KAAK,GAAgB;IACvC,IAAI;QACA,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,QAAQ,EAAE,MAAM,EAAE,SAAS,EAAE,GAAG;QAEhE,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,YAAY,CAAC,QAAQ;YACpD,OAAO,gMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QACjF;QAEA,MAAM,kBAAkB,OAAO;QAC/B,IAAI,MAAM,oBAAoB,mBAAmB,GAAG;YAChD,OAAO,gMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,SAAS,MAAM,uLAAE,CAAC,cAAc,CAAC,OAAO;YAC1C,MAAM,YAAY,uLAAE,CAAC,UAAU,CAAC,YAAY,GAAG,CAAC;YAChD,MAAM,YAAY,MAAM,YAAY,GAAG,CAAC;YAExC,IAAI,CAAC,UAAU,MAAM,EAAE;gBACnB,MAAM,IAAI,MAAM;YACpB;YAEA,MAAM,aAAa,UAAU,IAAI;YACjC,MAAM,aAAa,WAAW,eAAe;YAE7C,IAAI,aAAa,iBAAiB;gBAC9B,MAAM,IAAI,MAAM;YACpB;YAEA,MAAM,SAAS,aAAa;YAE5B,mBAAmB;YACnB,YAAY,MAAM,CAAC,WAAW;gBAAE,iBAAiB;YAAO;YAExD,uBAAuB;YACvB,MAAM,gBAAgB,uLAAE,CAAC,UAAU,CAAC,eAAe,GAAG;YACtD,MAAM,aAAkB;gBACpB,IAAI,cAAc,EAAE;gBACpB,UAAU;gBACV,cAAc;gBACd,mBAAmB;gBACnB,aAAa,yKAAS,CAAC,GAAG;gBAC1B,YAAY;oBACR,KAAK;oBACL,OAAO,aAAa;gBACxB;YACJ;YACA,YAAY,GAAG,CAAC,eAAe;YAE/B,OAAO;gBAAE;gBAAQ,cAAc,cAAc,EAAE;YAAC;QACpD;QAEA,OAAO,gMAAY,CAAC,IAAI,CAAC;YAAE,QAAQ;YAAW,GAAG,MAAM;QAAC;IAE5D,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,uBAAuB;QACrC,IAAI,MAAM,OAAO,KAAK,sBAAsB;YACxC,OAAO,gMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI,IAAI,WAAW;QAC3F;QACA,IAAI,MAAM,OAAO,KAAK,oBAAoB;YACtC,OAAO,gMAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QACA,OAAO,gMAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO,IAAI;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAChG;AACJ"}}]
}