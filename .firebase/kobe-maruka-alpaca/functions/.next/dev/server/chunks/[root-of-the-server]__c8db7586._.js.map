{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%E5%B2%A1%E6%9C%AC%E3%80%80%E6%99%83%E4%B8%80/projects/kobe-maruka-project/web/src/lib/firebase-admin.ts"],"sourcesContent":["import * as admin from 'firebase-admin';\r\n\r\nif (!process.env.FIRESTORE_EMULATOR_HOST) {\r\n    // In production, we would check for service account credentials here.\r\n    // For this dev environment, we enforce emulator usage or specific setup.\r\n    console.warn(\"FIRESTORE_EMULATOR_HOST is not set. Ensure you are connecting to the correct instance.\");\r\n}\r\n\r\nif (admin.apps.length === 0) {\r\n    admin.initializeApp({\r\n        projectId: 'demo-no-project',\r\n    });\r\n}\r\n\r\nexport const db = admin.firestore();\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,uBAAuB,EAAE;IACtC,sEAAsE;IACtE,yEAAyE;IACzE,QAAQ,IAAI,CAAC;AACjB;AAEA,IAAI,mIAAU,CAAC,MAAM,KAAK,GAAG;IACzB,4IAAmB,CAAC;QAChB,WAAW;IACf;AACJ;AAEO,MAAM,KAAK,wIAAe"}},
    {"offset": {"line": 73, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%E5%B2%A1%E6%9C%AC%E3%80%80%E6%99%83%E4%B8%80/projects/kobe-maruka-project/web/src/types/schema.ts"],"sourcesContent":["import { Timestamp } from 'firebase-admin/firestore';\r\n\r\n/**\r\n * Supply Status Enum\r\n * Strict definition using const assertion for type safety.\r\n */\r\nexport const SupplyStatus = {\r\n    PENDING: 'pending',\r\n    PROCESSING: 'processing',\r\n    COMPLETED: 'completed',\r\n} as const;\r\n\r\nexport type SupplyStatus = typeof SupplyStatus[keyof typeof SupplyStatus];\r\n\r\n/**\r\n * Collection: supplies\r\n */\r\nexport interface Supply {\r\n    id: string; // UUID\r\n    faxId: string;\r\n    status: SupplyStatus;\r\n    productName: string;\r\n    initialQuantity: number; // >= 0\r\n    currentQuantity: number; // >= 0\r\n    createdAt: Timestamp;\r\n}\r\n\r\n/**\r\n * Collection: allocations\r\n * Root Collection\r\n */\r\nexport interface Allocation {\r\n    id?: string; // Firestore auto-id is fine, or UUID\r\n    supplyId: string; // Foreign key to supplies\r\n    customerName: string;\r\n    allocatedQuantity: number; // >= 1\r\n    allocatedAt: Timestamp;\r\n}\r\n"],"names":[],"mappings":";;;;AAMO,MAAM,eAAe;IACxB,SAAS;IACT,YAAY;IACZ,WAAW;AACf"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%E5%B2%A1%E6%9C%AC%E3%80%80%E6%99%83%E4%B8%80/projects/kobe-maruka-project/web/src/app/api/ingest/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { GoogleGenerativeAI } from \"@google/generative-ai\";\r\nimport { z } from \"zod\";\r\nimport { v4 as uuidv4 } from 'uuid';\r\nimport { db } from '@/lib/firebase-admin';\r\nimport { Supply, SupplyStatus } from '@/types/schema';\r\nimport { Timestamp } from 'firebase-admin/firestore';\r\n\r\n// --- Configuration ---\r\nconst API_KEY = process.env.GEMINI_API_KEY;\r\nconst MODEL_NAME = process.env.GEMINI_MODEL_NAME || \"gemini-1.5-flash\";\r\n\r\n// --- Zod Schema (Ported from Task-2) ---\r\nconst FirstString = z.union([\r\n    z.string(),\r\n    z.number().transform(String),\r\n    z.array(z.union([z.string(), z.number().transform(String)]))\r\n]).transform((val) => {\r\n    if (Array.isArray(val)) return val[0] || \"\";\r\n    return val;\r\n});\r\n\r\nconst CoerceNumber = z.union([\r\n    z.string(),\r\n    z.number(),\r\n    z.array(z.union([z.string(), z.number()]))\r\n]).transform((val) => {\r\n    let v: string | number;\r\n    if (Array.isArray(val)) {\r\n        v = val[0];\r\n    } else {\r\n        v = val;\r\n    }\r\n    const parsed = Number(v);\r\n    if (isNaN(parsed)) {\r\n        throw new Error(`Quantity is not a valid number: ${v}`);\r\n    }\r\n    return parsed;\r\n});\r\n\r\nconst ItemSchema = z.object({\r\n    grade: FirstString.optional(),\r\n    class: FirstString.optional(),\r\n    quantity: CoerceNumber,\r\n});\r\n\r\nconst DetailSchema = z.object({\r\n    name: FirstString.optional(),\r\n    packaging: FirstString.optional(),\r\n    items: z.array(ItemSchema).optional(),\r\n});\r\n\r\nconst OcrResultSchema = z.object({\r\n    send_dt: FirstString.optional(),\r\n    origin: FirstString.optional(),\r\n    details: z.array(DetailSchema).optional(),\r\n});\r\n\r\ntype OcrResult = z.infer<typeof OcrResultSchema>;\r\n\r\nfunction flattenToSupplies(ocrResult: OcrResult): Supply[] {\r\n    const supplies: Supply[] = [];\r\n    const now = Timestamp.now();\r\n\r\n    if (!ocrResult.details) return [];\r\n\r\n    for (const detail of ocrResult.details) {\r\n        if (!detail.items) continue;\r\n        for (const item of detail.items) {\r\n            supplies.push({\r\n                id: uuidv4(),\r\n                faxId: \"fax-\" + uuidv4().substring(0, 8), // Dummy ID for now\r\n                status: SupplyStatus.PENDING,\r\n                productName: detail.name || \"Unknown Product\",\r\n                initialQuantity: item.quantity,\r\n                currentQuantity: item.quantity,\r\n                createdAt: now,\r\n            });\r\n        }\r\n    }\r\n    return supplies;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n    try {\r\n        if (!API_KEY) {\r\n            return NextResponse.json({ error: \"Server Configuration Error: GEMINI_API_KEY missing\" }, { status: 500 });\r\n        }\r\n\r\n        const body = await req.json();\r\n        const { imageBase64 } = body;\r\n\r\n        if (!imageBase64) {\r\n            return NextResponse.json({ error: \"Missing imageBase64\" }, { status: 400 });\r\n        }\r\n\r\n        // --- MOCK MODE ---\r\n        let responseText: string;\r\n        if (imageBase64 === \"TEST_IMAGE_DATA\") {\r\n            console.log(\"--- MOCK MODE TRIGGERED ---\");\r\n            responseText = JSON.stringify({\r\n                send_dt: \"2023/11/24\",\r\n                origin: \"Mock JA\",\r\n                details: [\r\n                    {\r\n                        name: \"Mock Product\",\r\n                        packaging: \"Mock Box\",\r\n                        items: [\r\n                            { grade: \"A\", class: \"L\", quantity: 100 }\r\n                        ]\r\n                    }\r\n                ]\r\n            });\r\n        } else {\r\n            // --- REAL GEMINI CALL ---\r\n            const genAI = new GoogleGenerativeAI(API_KEY);\r\n            const model = genAI.getGenerativeModel({\r\n                model: MODEL_NAME,\r\n                generationConfig: {\r\n                    responseMimeType: \"application/json\",\r\n                    temperature: 0,\r\n                }\r\n            });\r\n\r\n            const promptParts: any[] = [\r\n                \"あなたは帳票データ化の専門家です。\",\r\n                \"添付された画像を、各項目の指示と思考ステップに従って分析し、最終的に全ての情報を統合して一つのJSONとして出力してください。\",\r\n                \"**出力ルール:**\",\r\n                \"共通情報はトップレベルに、明細は `details` 配列の中に、等級・階級ごとの数量を `items` 配列内の個別のオブジェクトとして格納してください。\",\r\n                \"**期待する出力JSON形式 (あくまで構造の例です。この値をそのまま出力しないでください):**\",\r\n                `{\r\n                  \"send_dt\": [\"YYYY/MM/DD\"],\r\n                  \"origin\": [\"JA名など\"],\r\n                  \"details\": [\r\n                    {\r\n                      \"name\": [\"品名\"],\r\n                      \"packaging\": [\"荷姿\"],\r\n                      \"items\": [\r\n                        { \"grade\": [\"等級\"], \"class\": [\"階級\"], \"quantity\": [\"数量\"] }\r\n                      ]\r\n                    }\r\n                  ]\r\n                }`,\r\n                \"**思考ステップ:**\",\r\n                \"1. **画像分析:** 画像が空白、真っ黒、あるいは判読不能な場合は、直ちに `null` を返してください。例示されたデータを返してはいけません。\",\r\n                \"2. **共通情報の特定:** 帳票全体で共通する「出荷年月日」を探し、日付をYYYY/MM/DD形式で特定する。また、「出荷元」を探し、右上のJA名を2つ見つけて結合する。\",\r\n                \"3. **明細行の特定:** 品目が書かれている行を特定し、そこから「品名」と「荷姿」を読み取る。\",\r\n                \"4. **数量マトリクスの分解:** 明細行の表から「0以外の数値セル」を探す。\",\r\n                \"5. **属性の紐付け:** 見つけた数値セルの列を上に辿ってヘッダーから「等級」と「階級」を特定し、その交差する数値を「数量」とする。\",\r\n                \"6. **完了:** すべての情報を統合してJSONのみを返す。\",\r\n                {\r\n                    inlineData: {\r\n                        data: imageBase64,\r\n                        mimeType: \"image/jpeg\"\r\n                    }\r\n                }\r\n            ];\r\n\r\n            const result = await model.generateContent(promptParts);\r\n            responseText = result.response.text();\r\n        }\r\n\r\n        if (!responseText || responseText.trim() === \"null\" || responseText.trim() === \"```json\\nnull\\n```\") {\r\n            return NextResponse.json({ error: \"Unreadable FAX\" }, { status: 422 });\r\n        }\r\n\r\n        let parsedJson;\r\n        try {\r\n            parsedJson = JSON.parse(responseText);\r\n        } catch (e) {\r\n            return NextResponse.json({ error: \"Invalid JSON from AI\" }, { status: 422 });\r\n        }\r\n\r\n        if (parsedJson === null) {\r\n            return NextResponse.json({ error: \"Unreadable FAX (Null)\" }, { status: 422 });\r\n        }\r\n\r\n        const validationResult = OcrResultSchema.safeParse(parsedJson);\r\n\r\n        if (!validationResult.success) {\r\n            return NextResponse.json({ error: \"Validation Failed\", details: validationResult.error.format() }, { status: 422 });\r\n        }\r\n\r\n        const supplies = flattenToSupplies(validationResult.data);\r\n\r\n        // --- Firestore Save ---\r\n        const batch = db.batch();\r\n        const createdIds: string[] = [];\r\n\r\n        for (const supply of supplies) {\r\n            const ref = db.collection('supplies').doc(supply.id);\r\n            // Convert custom object to plain object for Firestore if needed, \r\n            // but Admin SDK handles basic objects well. \r\n            // However, Timestamp might need care if passed from client, but here it's server-side created.\r\n            batch.set(ref, supply);\r\n            createdIds.push(supply.id);\r\n        }\r\n\r\n        await batch.commit();\r\n\r\n        return NextResponse.json({\r\n            status: \"success\",\r\n            count: supplies.length,\r\n            ids: createdIds,\r\n            data: supplies\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error(\"Ingest API Error:\", error);\r\n        return NextResponse.json({ error: error.message || \"Internal Server Error\" }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}